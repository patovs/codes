#!/bin/bash
OPCION=$1
RUTA_LOG_SCAN_FILE=/root/apps/codes/log-scan

echo "El script ejecutarÃ¡ un anÃ¡lisis al sistema detectando infecciones PHP y otras truculencias"
#read OPCION

case $OPCION in
	1 )
		echo "Ingrese el username: "
		read USER
		FILE_LOG=$(date +%d-%m-%Y)_$USER
		echo "El resultado serÃ¡ guardado en el archivo $RUTA_LOG_SCAN_FILE/$FILE_LOG"
		echo "El escaneo iniciarÃ¡ en 5 segundos..."
		sleep 5
		egrep -n -r -I --exclude="sym" '(\\x[a-z]|\\x[0-9]|<?php if\(isset\(|eval\(base64_decode\(gzuncompress|gzuncompress|base64_decode|;eval\()|GIF89aG|b374k' /home/$USER/public_html --include=*.php | awk -F":" '{print $1":"$2":\t"$3}' | egrep '(:1:)' >> $RUTA_LOG_SCAN_FILE/$FILE_LOG
		echo "Escaneo completo."
		exit 1
		;;
	2 ) 
		FILE_LOG=$(date +%d-%m-%Y)_resultado
		echo "El resultado del escaneo se guardarÃ¡ en $RUTA_LOG_SCAN_FILE/$FILE_LOG"
		echo "El escaneo iniciarÃ¡ en 5 segundos..."
		for USER in `cat /etc/trueuserdomains | awk '{print $2}'`
		do
        	if [ "$USER" != "patovs" ]
        	then
                echo -e "========================================================= $USER =============================================================\n" >> $RUTA_LOG_SCAN_FILE/$FILE_LOG
                egrep -n -r -I --exclude="sym" '(\\x[a-z]|\\x[0-9]|<?php if\(isset\(|eval\(base64_decode\(gzuncompress|gzuncompress|base64_decode|;eval\()|GIF89aG|b374k' /home/$USER/public_html --include=*.php | awk -F":" '{print $1":"$2":\t"$3}' | egrep '(:1:)' >> $RUTA_LOG_SCAN_FILE/$FILE_LOG
        	fi
		done
		echo "Escaneo terminado."
		exit 1
		;;
	3 )
		FILE_LOG=$(date +%d-%m-%Y)_resultado_full
		echo "El resultado del escaneo se guardarÃ¡ en $RUTA_LOG_SCAN_FILE/$FILE_LOG"
		echo "El escaneo iniciarÃ¡ en 5 segundos..."
		for USER in `cat /etc/trueuserdomains | awk '{print $2}'`
		do
        	if [ "$USER" != "patovs" ]
        	then
                echo -e "========================================================= $USER =============================================================\n" >> $RUTA_LOG_SCAN_FILE/$FILE_LOG
                egrep -n -r -I --exclude="root" '(\\x[a-z]|\\x[0-9]|<?php if\(isset\(|eval\(base64_decode\(gzuncompress|gzuncompress|base64_decode|;eval\()|GIF89aG|b374k' /home/$USER/public_html --include=*.php | awk -F":" '{print $1":"$2":\t"$3}' >> $RUTA_LOG_SCAN_FILE/$FILE_LOG
        	fi
		done
		echo "Escaneo terminado."
		exit 1
		;;
	4 )		
		echo "Ingrese el username: "
        read USER
		FILE_LOG=$(date +%d-%m-%Y)_$USER"_resultado_full"
		echo "El resultado del escaneo se guardarÃ¡ en $RUTA_LOG_SCAN_FILE/$FILE_LOG"
		echo "El escaneo iniciarÃ¡ en 5 segundos..."
		for USER in `cat /etc/trueuserdomains | awk '{print $2}'`
		do
        	if [ "$USER" != "patovs" ]
        	then
                echo -e "========================================================= $USER =============================================================\n" >> $RUTA_LOG_SCAN_FILE/$FILE_LOG
                egrep -n -r -I --exclude="root" --exclude="sym" --exclude="1.txt" '(\\x[a-z]|\\x[0-9]|<?php if\(isset\(|eval\(base64_decode\(gzuncompress|gzuncompress|base64_decode|;eval\()|GIF89aG|b374k' /home/$USER/public_html --include=*.php | awk -F":" '{print $1":"$2":\t"$3}' >> $RUTA_LOG_SCAN_FILE/$FILE_LOG
        	fi
		done
		echo "Escaneo terminado."
		exit 1
		;;
	* )
		echo "Usage: ./informeInfeccion [1|2|3|4]"
		echo "Las opciones son:"
		echo "1 - Un único usuario (escaneo simple)"
		echo "2 - Todos los usuarios (escaneo simple)"
		echo "3 - Un único usuario (escaneo completo)"
		echo "4 - Todos los usuarios (escaneo completo)"
		exit 1
		;;
esac


